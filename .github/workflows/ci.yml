name: CI

on:
  push:
    branches:
      - '**' # Trigger on all branch pushes
  pull_request:
    branches:
      - main
  workflow_dispatch: # Manual trigger option

jobs:
  test:
    name: Test on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false # Continue testing other platforms if one fails
      matrix:
        os: [ubuntu-latest, windows-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PowerShell
        shell: pwsh
        run: |
          Write-Host "PowerShell Version: $($PSVersionTable.PSVersion)"
          Write-Host "OS: $($PSVersionTable.OS)"

      - name: Cache PowerShell Modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.local/share/powershell/Modules
            ~/Documents/PowerShell/Modules
            C:\Users\runneradmin\Documents\PowerShell\Modules
          key: ${{ runner.os }}-pester-${{ hashFiles('**/ci.yml') }}
          restore-keys: |
            ${{ runner.os }}-pester-

      - name: Install Pester
        shell: pwsh
        run: |
          # Check if Pester is already cached
          $pester = Get-Module -ListAvailable -Name Pester | Where-Object { $_.Version -ge '5.0.0' } | Select-Object -First 1
          if ($pester) {
            Write-Host "Using cached Pester version: $($pester.Version)" -ForegroundColor Green
          } else {
            Write-Host "Installing Pester module..." -ForegroundColor Cyan
            Install-Module -Name Pester -MinimumVersion 5.0.0 -Force -Scope CurrentUser -SkipPublisherCheck
          }
          Import-Module Pester
          Write-Host "Pester version: $((Get-Module Pester).Version)" -ForegroundColor Green

      - name: Cache Bicep CLI (Ubuntu)
        if: runner.os == 'Linux'
        uses: actions/cache@v4
        with:
          path: ~/.azure/bin
          key: ${{ runner.os }}-bicep-${{ hashFiles('**/ci.yml') }}
          restore-keys: |
            ${{ runner.os }}-bicep-

      - name: Cache Bicep CLI (Windows)
        if: runner.os == 'Windows'
        uses: actions/cache@v4
        with:
          path: C:\Program Files\Bicep CLI
          key: ${{ runner.os }}-bicep-${{ hashFiles('**/ci.yml') }}
          restore-keys: |
            ${{ runner.os }}-bicep-

      - name: Install Bicep CLI (Ubuntu)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          # NOTE: Bicep CLI installation is for testing the Bicep starter package
          # The core Bolt orchestrator has no dependency on Bicep
          # Check if Bicep is already cached
          if command -v bicep &> /dev/null; then
            echo "✓ Using cached Bicep CLI"
            bicep --version
          else
            echo "Installing Azure CLI (includes Bicep)..."
            curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
            echo "✓ Bicep CLI installed"
            az bicep version
          fi

      - name: Install Bicep CLI (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          # NOTE: Bicep CLI installation is for testing the Bicep starter package
          # The core Bolt orchestrator has no dependency on Bicep
          # Check if Bicep is already cached
          $bicepPath = "C:\Program Files\Bicep CLI\bicep.exe"
          if (Test-Path $bicepPath) {
            Write-Host "✓ Using cached Bicep CLI" -ForegroundColor Green
            $env:PATH = "C:\Program Files\Bicep CLI;$env:PATH"
            bicep --version
          } else {
            Write-Host "Installing Bicep via winget..." -ForegroundColor Cyan
            winget install Microsoft.Bicep --silent --accept-package-agreements --accept-source-agreements
            $env:PATH = "C:\Program Files\Bicep CLI;$env:PATH"
            Write-Host "✓ Bicep CLI installed" -ForegroundColor Green
            bicep --version
          }

      - name: Install Terraform CLI (Ubuntu)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          # NOTE: Terraform CLI installation is for testing the Terraform starter package
          # The core Bolt orchestrator has no dependency on Terraform
          # Check if Terraform is already installed
          if command -v terraform &> /dev/null; then
            echo "✓ Terraform CLI already installed"
            terraform version
          else
            echo "Installing Terraform CLI..."
            wget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
            echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
            sudo apt update && sudo apt install -y terraform
            echo "✓ Terraform CLI installed"
            terraform version
          fi

      - name: Install Terraform CLI (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          # NOTE: Terraform CLI installation is for testing the Terraform starter package
          # The core Bolt orchestrator has no dependency on Terraform
          # Check if Terraform is already installed
          if (Get-Command terraform -ErrorAction SilentlyContinue) {
            Write-Host "✓ Terraform CLI already installed" -ForegroundColor Green
            terraform version
          } else {
            Write-Host "Installing Terraform via Chocolatey..." -ForegroundColor Cyan
            choco install terraform -y
            Write-Host "✓ Terraform CLI installed" -ForegroundColor Green
            terraform version
          }

      - name: Run Core Tests (Fast)
        shell: pwsh
        run: |
          Write-Host "Running Core tests (no Bicep dependencies)..." -ForegroundColor Cyan
          $coreResult = Invoke-Pester -Tag Core -Output Detailed -PassThru
          if ($coreResult.FailedCount -gt 0) {
            Write-Error "Core tests failed: $($coreResult.FailedCount) test(s)"
            exit 1
          }

      - name: Run Bicep Tasks Tests (Requires Bicep)
        shell: pwsh
        run: |
          Write-Host "Running Bicep-Tasks tests (Bicep required)..." -ForegroundColor Cyan
          $tasksResult = Invoke-Pester -Tag Bicep-Tasks -Output Detailed -PassThru
          if ($tasksResult.FailedCount -gt 0) {
            Write-Error "Bicep-Tasks tests failed: $($tasksResult.FailedCount) test(s)"
            exit 1
          }

      - name: Run All Tests with NUnit XML Report
        shell: pwsh
        run: |
          Write-Host "Generating test report..." -ForegroundColor Cyan
          $config = New-PesterConfiguration
          $config.Run.Path = @(
            'tests'
            'packages/.build-bicep/tests'
            'packages/.build-golang/tests'
            'packages/.build-terraform/tests'
          )
          $config.Run.Exit = $false
          $config.TestResult.Enabled = $true
          $config.TestResult.OutputFormat = 'NUnitXml'
          $config.TestResult.OutputPath = 'TestResults-${{ matrix.os }}.xml'
          $config.Output.Verbosity = 'Detailed'

          $result = Invoke-Pester -Configuration $config

          Write-Host "Tests Passed: $($result.PassedCount)" -ForegroundColor Green
          Write-Host "Tests Failed: $($result.FailedCount)" -ForegroundColor $(if ($result.FailedCount -gt 0) { 'Red' } else { 'Green' })
          Write-Host "Tests Skipped: $($result.SkippedCount)" -ForegroundColor Yellow

          if ($result.FailedCount -gt 0) {
            Write-Error "Test suite failed with $($result.FailedCount) failure(s)"
            exit 1
          }

      - name: Upload Test Results
        if: always() # Upload even if tests fail
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.os }}
          path: TestResults-${{ matrix.os }}.xml
          retention-days: 30

      - name: Run Build Pipeline
        shell: pwsh
        run: |
          Write-Host "Running full build pipeline: format → lint → build" -ForegroundColor Cyan
          pwsh -File bolt.ps1 build
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Build pipeline failed"
            exit 1
          }
          Write-Host "✓ Build pipeline completed successfully" -ForegroundColor Green

      - name: Verify Build Artifacts
        shell: pwsh
        run: |
          Write-Host "Checking for compiled ARM templates..." -ForegroundColor Cyan
          $jsonFiles = Get-ChildItem -Path packages/.build-bicep/tests/iac -Filter "*.json" -Recurse -File
          if ($jsonFiles.Count -eq 0) {
            Write-Error "No .json files found - build may have failed"
            exit 1
          }
          Write-Host "Found $($jsonFiles.Count) compiled template(s):" -ForegroundColor Green
          $jsonFiles | ForEach-Object { Write-Host "  - $($_.Name)" -ForegroundColor Gray }

      - name: Test Manifest Generation
        shell: pwsh
        run: |
          Write-Host "Testing manifest generation scripts..." -ForegroundColor Cyan

          # Test local manifest generation (requires Bolt module)
          Write-Host "Creating test module for manifest generation..." -ForegroundColor Gray
          pwsh -File infra/New-BoltModule.ps1 -Install -NoImport -ModuleOutputPath ".\test-module"

          # Test manifest generation
          Write-Host "Testing generate-manifest.ps1..." -ForegroundColor Gray
          pwsh -File infra/generate-manifest.ps1 -ModulePath "test-module/Bolt/Bolt.psm1" -ModuleVersion "0.0.1" -Tags "Test,CI"

          # Verify manifest was created
          $manifestPath = "test-module/Bolt/Bolt.psd1"
          if (-not (Test-Path -Path $manifestPath)) {
            Write-Error "Manifest file not created at $manifestPath"
            exit 1
          }

          # Test manifest is valid
          Write-Host "Validating generated manifest..." -ForegroundColor Gray
          $manifest = Test-ModuleManifest -Path $manifestPath -ErrorAction Stop
          Write-Host "✓ Manifest validation passed: $($manifest.Name) v$($manifest.Version)" -ForegroundColor Green

          # Clean up
          Remove-Item -Path "test-module" -Recurse -Force -ErrorAction SilentlyContinue
          Write-Host "✓ Manifest generation tests completed" -ForegroundColor Green
